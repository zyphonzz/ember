<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ember</title>
<style>
:root{
  --bg:#070607;
  --panel:#0f1214;
  --muted:#aab3b9;
  --text:#e8eef2;
  --accent:#ff7a2e; /* default subtle orange */
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
  --card-radius:10px;
}
/* reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Courier New", monospace;
  background: var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden;
}

/* canvas bg full-screen */
#bg-canvas{
  position:fixed; inset:0; z-index:0; display:block;
  background: linear-gradient(180deg, rgba(0,0,0,0.18), transparent 30%);
}

/* main shell */
.app{
  position:relative; z-index:3;
  max-width:1200px; margin:28px auto; display:grid;
  grid-template-columns: 260px 1fr; gap:18px; align-items:start;
  height: calc(100vh - 56px);
  pointer-events:none; /* allow clicks to go through to panels unless overridden */
}

/* panels allow pointer events */
.panel{pointer-events:auto}

/* header spans both columns */
.header{
  grid-column:1/-1; display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:14px 16px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border:1px solid rgba(255,255,255,0.03); backdrop-filter: blur(6px); box-shadow: 0 12px 40px rgba(0,0,0,0.6);
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  background: linear-gradient(135deg,var(--accent), rgba(255,255,255,0.06));
  color:#071014;font-weight:800;font-family:monospace;font-size:18px;box-shadow:0 8px 28px rgba(0,0,0,0.6);
}
.brand h1{font-size:18px}
.header-actions{display:flex;gap:8px;align-items:center}

/* sidebar */
.sidebar{
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
  height:100%; overflow:auto;
}
.search{display:flex;gap:8px;margin-bottom:12px}
.search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
.filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:10px}
.filter-btn{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted);font-weight:700;cursor:pointer}
.filter-btn.active{background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:var(--text); box-shadow: inset 0 -1px rgba(255,255,255,0.01)}

/* main area */
.main{
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03); height:100%; overflow:auto;
}
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}

/* card */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;min-height:170px;transition:transform .12s ease}
.card:hover{transform:translateY(-8px);box-shadow:0 18px 60px rgba(0,0,0,0.6)}
.title{font-weight:800}
.desc{color:var(--muted);font-size:13px;margin-top:6px}
.row{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.tag{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:700;font-size:12px;border:1px solid rgba(255,255,255,0.02)}
.actions{margin-top:auto;display:flex;justify-content:flex-end;gap:8px}
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:var(--text);cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--accent), rgba(255,255,255,0.06)); color:#071014;border:0;}

/* small text */
.muted{color:var(--muted);font-size:13px}

/* dev panel + login (hidden by default) */
.dev-panel, #login-panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:600}
.dev-panel .panel, #login-panel .panel{width:880px;max-width:96%;max-height:86%;overflow:auto;padding:18px}
#login-panel .panel{max-width:420px}

/* modal backdrop for settings */
.modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:700}
.modal{width:560px;max-width:96%;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.7);padding:12px;position:relative}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:8px;cursor:grab;background:rgba(255,255,255,0.01);border-radius:8px}
.modal-body{padding:12px;display:grid;gap:10px}
.input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}

small.note{color:var(--muted);font-size:12px}

/* loading overlay */
#loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:800}
.loading-text{color:var(--muted);font-weight:800;letter-spacing:2px}

/* responsive */
@media (max-width:980px){
  .app{grid-template-columns:1fr; padding-bottom:20px}
  .sidebar{order:2;height:auto}
  .main{order:1}
  .grid{grid-template-columns:1fr}
}

/* custom scrollbar subtle */
*::-webkit-scrollbar{height:10px;width:10px}
*::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.03);border-radius:8px}
</style>
</head>
<body>

<!-- canvas background -->
<canvas id="bg-canvas"></canvas>

<!-- top-level app -->
<div class="app" role="application" aria-label="Ember app">
  <header class="header panel">
    <div class="brand">
      <div class="logo">E</div>
      <div>
        <h1>EMBER</h1>
        <div class="muted" id="ver">v0.1</div>
      </div>
    </div>

    <div class="header-actions">
      <div class="muted" id="stats">0 apps</div>
      <button class="btn" id="btn-settings">Settings</button>
      <button class="btn" id="btn-dev">Dev</button>
    </div>
  </header>

  <aside class="sidebar panel" aria-label="Sidebar">
    <div class="search">
      <input id="q" placeholder="Filter . . ." />
      <button class="btn" id="clear-q">CLR</button>
    </div>

    <div style="margin-bottom:8px"><strong>Categories</strong></div>
    <div class="filter-grid" id="filter-grid"></div>
  </aside>

  <main class="main panel" aria-label="Main">
    <div class="toolbar">
      <div>
        <div class="muted" id="result-count">Showing 0 results</div>
      </div>
      <div>
        <button class="btn" id="btn-add">Add App</button>
        <button class="btn" id="btn-sample">Sample</button>
        <button class="btn" id="btn-export">Export</button>
      </div>
    </div>

    <section class="grid" id="content-grid" aria-live="polite"></section>
  </main>
</div>

<!-- Dev Panel -->
<div class="dev-panel" id="dev-panel">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3>Developer Panel</h3>
      <div>
        <button class="btn" onclick="closeDevPanel()">Close</button>
      </div>
    </div>

    <!-- Add app -->
    <div style="border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:8px;margin-bottom:12px">
      <form id="add-app-form">
        <div style="display:grid;gap:8px">
          <input id="app-name" class="input" placeholder="Application Name" required />
          <textarea id="app-description" class="input" placeholder="Description"></textarea>
          <div style="display:flex;gap:8px">
            <input id="app-rating" class="input" placeholder="Rating (0-10)" type="number" step="0.1" />
            <input id="app-price" class="input" placeholder="Price (e.g. Free or $9.99)" />
          </div>
          <input id="app-link" class="input" placeholder="Link (optional)" />
          <input id="app-tags" class="input" placeholder="Tags (comma separated)" />
          <div style="display:flex;justify-content:flex-end;gap:8px">
            <button class="btn" type="button" onclick="closeDevPanel()">Cancel</button>
            <button class="btn primary" type="submit">Add Application</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Bulk operations -->
    <div style="border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:8px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btn-export2">Export Data</button>
        <button class="btn" id="btn-clear">Clear All</button>
        <button class="btn" id="btn-load-sample">Load Sample</button>
        <label class="btn" style="cursor:pointer">
          Import
          <input type="file" id="import-file" accept=".json" style="display:none" />
        </label>
      </div>

      <div style="margin-top:12px" class="muted">Total Applications: <span id="app-count">0</span></div>
    </div>
  </div>
</div>

<!-- Login Panel -->
<div class="dev-panel" id="login-panel">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3>Login</h3>
      <button class="btn" onclick="closeLoginPanel()">Close</button>
    </div>
    <form id="login-form">
      <input id="username" class="input" placeholder="Username" required />
      <input id="password" class="input" placeholder="Password" type="password" required />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn" type="button" onclick="closeLoginPanel()">Cancel</button>
        <button class="btn primary" type="submit">Login</button>
      </div>
      <div id="login-message" class="muted" style="margin-top:8px"></div>
    </form>
  </div>
</div>

<!-- settings modal (draggable) -->
<div class="modal-backdrop" id="settings-backdrop">
  <div class="modal" id="settings-modal" role="dialog" aria-modal="true" aria-label="Settings">
    <div class="modal-header" id="settings-header">
      <strong>Settings</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="restore-defaults">Restore</button>
        <button class="btn" id="close-settings">Close</button>
      </div>
    </div>
    <div class="modal-body">
      <div>
        <label>Accent color</label>
        <input type="color" id="accent-input" class="input" />
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" id="preset-orange">Default Orange</button>
          <button class="btn" id="preset-pink">Subtle Pink</button>
        </div>
      </div>

      <div>
        <label>Particles</label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <input type="checkbox" id="particles-toggle" />
          <small class="note">Enable / disable particle field</small>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
          <label class="muted">Density:</label>
          <input type="range" id="particles-density" min="0" max="200" step="5" />
          <span id="density-val" class="muted"></span>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
          <label class="muted">Speed:</label>
          <input type="range" id="particles-speed" min="0" max="2" step="0.05" />
          <span id="speed-val" class="muted"></span>
        </div>
      </div>

      <div>
        <label>Appearance</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" id="toggle-dark">Dark</button>
          <button class="btn" id="toggle-light">Light</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- small status toast -->
<div id="status" style="position:fixed;right:20px;bottom:20px;z-index:900;display:none;padding:10px 14px;border-radius:8px;background:rgba(0,0,0,0.6);color:#bfe"></div>

<script>
/* ================= Configuration (kept from your original) ================= */
const BIN_ID = '6832d5068561e97a501b3c2b';
const API_KEY = '$2a$10$hqlbz8FagW8YWBkeXVLhouovoqwqV4alPw/1i2Ty7Pf8YD..HJtlK';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

let applications = [];
let categories = [];
let isDevLoggedIn = false;

/* DEV CREDENTIALS left as original (unchanged) */
const DEV_CREDENTIALS = { username: "zyphonz", password: "Cookie113!" };

/* ================= Utilities ================= */
function showStatus(msg, t = 1800){
  const s = document.getElementById('status');
  s.textContent = msg; s.style.display = 'block';
  setTimeout(()=> s.style.display = 'none', t);
}
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

/* ======= Name-normalization: replace 'zyphonz' -> 'lunaz' inside app data ======= */
function normalizeNamesInApps(arr){
  if(!Array.isArray(arr)) return arr;
  const rx = /zyphonz/gi;
  return arr.map(app=>{
    const copy = JSON.parse(JSON.stringify(app));
    // fields to normalize: name, description, tags (and link? only names/cards requested — do tags too)
    if(copy.name && rx.test(copy.name)) copy.name = copy.name.replace(rx, 'lunaz');
    if(copy.description && rx.test(copy.description)) copy.description = copy.description.replace(rx, 'lunaz');
    if(Array.isArray(copy.tags)) copy.tags = copy.tags.map(t => (typeof t === 'string') ? t.replace(rx, 'lunaz') : t);
    return copy;
  });
}

/* ================= Remote (JSONBin) ================= */
async function fetchData(){
  try{
    const resp = await fetch(JSONBIN_URL, { headers: { 'X-Master-Key': API_KEY } });
    if(!resp.ok) throw new Error('fetch failed '+resp.status);
    const js = await resp.json();
    const rec = js.record || js;
    let apps = rec.applications || [];
    let cats = rec.categories || [];
    // normalize zyphonz -> lunaz in apps as requested
    apps = normalizeNamesInApps(apps);
    applications = apps;
    categories = cats;
    renderApplications();
    renderCategories();
    updateAppCount();
    showStatus('Data loaded');
  }catch(err){
    console.warn('fetchData failed', err);
    showStatus('Remote load failed — using local if available');
    // fallback to local
    loadFromLocal();
  }
}

async function saveData(){
  const payload = { applications, categories };
  try{
    await fetch(JSONBIN_URL, {
      method:'PUT',
      headers:{ 'Content-Type':'application/json', 'X-Master-Key': API_KEY },
      body: JSON.stringify(payload)
    });
    showStatus('Saved to remote');
  }catch(err){
    console.warn('saveData failed', err);
    showStatus('Save remote failed (check keys)');
  }
}

/* ================ Local storage ================ */
const STORAGE_KEY = 'ember_v1_data';
function saveLocal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ applications, categories }));
}
function loadFromLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) { // initialize defaults if nothing
    applications = [];
    categories = ['all','util','tv','python','ai','security','gaming'];
    saveLocal();
    renderApplications(); renderCategories(); updateAppCount();
    return;
  }
  try{
    const parsed = JSON.parse(raw);
    // normalize names as well
    parsed.applications = normalizeNamesInApps(parsed.applications || []);
    applications = parsed.applications || [];
    categories = parsed.categories || [];
    renderApplications(); renderCategories(); updateAppCount();
  }catch(e){
    console.error('local parse', e);
    applications = []; categories = ['all'];
    renderApplications(); renderCategories(); updateAppCount();
  }
}

/* ================= Render UI ================= */
function updateAppCount(){
  const el = document.getElementById('app-count');
  const stats = document.getElementById('stats');
  const rc = document.getElementById('result-count');
  const total = applications.length;
  if(el) el.textContent = total;
  if(stats) stats.textContent = `${total} apps`;
  if(rc) rc.textContent = `Showing ${total} results`;
}

function renderCategories(){
  const grid = document.getElementById('filter-grid');
  grid.innerHTML = '';
  // ensure 'all' included
  if(!categories.includes('all')) categories.unshift('all');
  categories.forEach(cat=>{
    const b = document.createElement('button');
    b.className = 'filter-btn';
    b.dataset.filter = cat;
    b.textContent = cat.replace('-', ' ');
    if(cat === 'tv') b.classList.add('active');
    b.addEventListener('click', ()=> {
      document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      filterApplications(cat);
    });
    grid.appendChild(b);
  });
}

function renderApplications(apps = applications){
  const container = document.getElementById('content-grid');
  const rc = document.getElementById('result-count');
  container.innerHTML = '';
  rc && (rc.textContent = `Showing ${apps.length} results`);
  if(!apps.length){
    container.innerHTML = `<div style="grid-column:1/-1;padding:28px;border-radius:10px;background:rgba(255,255,255,0.01);color:var(--muted);text-align:center">No apps available.</div>`;
    return;
  }

  apps.forEach(a=>{
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.02));display:flex;align-items:center;justify-content:center;font-weight:800">${escapeHtml((a.name||'').charAt(0) || 'E')}</div>
        <div style="flex:1">
          <div class="title">${escapeHtml(a.name)}</div>
          <div class="desc">${escapeHtml(a.description || '')}</div>
        </div>
      </div>
      <div class="row" aria-hidden="true">
        <div class="tag">Rating: ${typeof a.rating !== 'undefined' ? escapeHtml(a.rating) : '—'}</div>
        <div class="tag">${escapeHtml(a.price || 'Free')}</div>
        ${(a.tags||[]).slice(0,5).map(t=>`<div class="tag">${escapeHtml(t)}</div>`).join('')}
      </div>
      <div class="actions">
        <button class="btn" onclick="openAppLink(${JSON.stringify(a.link||'#')}, ${JSON.stringify(a.name||'')})" ${!a.link ? 'disabled' : ''}>${a.link ? 'Visit' : 'No Link'}</button>
        <button class="btn" onclick="editApplication(${a.id})">Edit</button>
        <button class="btn" onclick="deleteApplication(${a.id})">Delete</button>
      </div>
    `;
    container.appendChild(card);
  });
}

/* ================= CRUD ================= */
function addApplicationFromForm(ev){
  ev.preventDefault();
  const name = document.getElementById('app-name').value.trim();
  if(!name) return alert('Name required');
  const desc = document.getElementById('app-description').value.trim();
  const rating = parseFloat(document.getElementById('app-rating').value) || 0;
  const price = document.getElementById('app-price').value.trim() || 'Free';
  const link = document.getElementById('app-link').value.trim() || '';
  const tags = (document.getElementById('app-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const id = Date.now();
  const app = { id, name, description: desc, rating, price, link, tags };
  // normalize name substitution locally as well (in case user types zyphonz)
  const normalized = normalizeNamesInApps([app])[0];
  applications.push(normalized);
  // add tags to categories
  tags.forEach(t => { if(!categories.includes(t)) categories.push(t) });
  saveLocal(); renderApplications(); renderCategories();
  // finish adding app flow
  saveLocal(); renderApplications(); renderCategories(); updateAppCount();
  showStatus('Application added');
  // reset the form
  document.getElementById('add-app-form').reset();
}

/* Edit / Delete */
function editApplication(id){
  const app = applications.find(a => a.id === id);
  if(!app) return showStatus('App not found');
  // open a modal-like prompt for editing (simple inline)
  openEditModal(app);
}

function openEditModal(app){
  const html = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Edit Application</strong>
      <div><button class="btn" onclick="closeModal()">Close</button></div>
    </div>
    <div style="margin-top:10px;display:grid;gap:8px">
      <input id="edit-name" class="input" value="${escapeHtml(app.name)}" />
      <textarea id="edit-desc" class="input" rows="4">${escapeHtml(app.description||'')}</textarea>
      <div style="display:flex;gap:8px">
        <input id="edit-rating" class="input" value="${escapeHtml(app.rating)}" />
        <input id="edit-price" class="input" value="${escapeHtml(app.price||'')}" />
      </div>
      <input id="edit-link" class="input" value="${escapeHtml(app.link||'')}" />
      <input id="edit-tags" class="input" value="${escapeHtml((app.tags||[]).join(','))}" />
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="saveEdit(${app.id})">Save</button>
      </div>
    </div>
  `;
  openModal(html);
}

function saveEdit(id){
  const idx = applications.findIndex(a => a.id === id);
  if(idx === -1) return showStatus('App missing');
  const name = document.getElementById('edit-name').value.trim();
  if(!name) return alert('Name required');
  const description = document.getElementById('edit-desc').value.trim();
  const rating = Number(document.getElementById('edit-rating').value) || 0;
  const price = document.getElementById('edit-price').value.trim() || 'Free';
  const link = document.getElementById('edit-link').value.trim() || '';
  const tags = (document.getElementById('edit-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const updated = { ...applications[idx], name, description, rating, price, link, tags };
  // normalize instance if user typed 'zyphonz'
  applications[idx] = normalizeNamesInApps([updated])[0];
  // ensure categories updated
  tags.forEach(t=>{ if(!categories.includes(t)) categories.push(t); });
  saveLocal(); renderApplications(); renderCategories(); updateAppCount(); closeModal();
  showStatus('Saved changes');
}

/* Delete */
function deleteApplication(id){
  if(!confirm('Delete this application?')) return;
  applications = applications.filter(a=>a.id !== id);
  saveLocal(); renderApplications(); renderCategories(); updateAppCount();
  showStatus('Deleted');
}

/* Open link */
function openAppLink(url, name){
  if(!url || url === '#'){ showStatus('No link available'); return; }
  try{ window.open(url, '_blank', 'noopener'); showStatus('Opening ' + (name || 'site')); } catch(e){ console.warn(e); }
}

/* Filter & Search helpers */
function filterApplications(filter){
  if(filter === 'all') { renderApplications(); updateAppCount(); return; }
  const filtered = applications.filter(a => (a.tags||[]).includes(filter) || (a.name||'').toLowerCase().includes(filter.toLowerCase()));
  renderApplications(filtered); updateAppCount();
}

document.getElementById('q').addEventListener('input', (e) => {
  const val = e.target.value.trim();
  if(!val) { renderApplications(); updateAppCount(); return; }
  const filtered = applications.filter(a=>
    (a.name||'').toLowerCase().includes(val.toLowerCase()) ||
    (a.description||'').toLowerCase().includes(val.toLowerCase()) ||
    (a.tags||[]).some(t => (t||'').toLowerCase().includes(val.toLowerCase()))
  );
  renderApplications(filtered);
});

/* Import / Export */
document.getElementById('import-file').addEventListener('change', (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const parsed = JSON.parse(e.target.result);
      if(!parsed.applications) return alert('Invalid file: missing applications array');
      // normalize incoming
      parsed.applications = normalizeNamesInApps(parsed.applications || []);
      applications = parsed.applications;
      categories = parsed.categories || categories;
      saveLocal(); renderApplications(); renderCategories(); updateAppCount(); showStatus('Imported');
    }catch(err){
      alert('Import failed: ' + err.message);
    }
  };
  reader.readAsText(f);
  ev.target.value = '';
});

function exportData(){
  const blob = new Blob([JSON.stringify({ applications, categories }, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ember_data_export.json'; a.click();
  URL.revokeObjectURL(url);
  showStatus('Exported');
}
document.getElementById('btn-export').addEventListener('click', exportData);
document.getElementById('btn-export2').addEventListener('click', exportData);

/* Load sample and clear */
function loadSampleData(){
  applications = [
    { id: 1, name: 'ember-player', description: 'Video player', rating: 8.9, price: 'Free', link: '#', tags: ['tv','linux'] },
    { id: 2, name: 'ember-studio', description: 'Compact code editor', rating: 8.6, price: '$4.99', link: '#', tags: ['python','web'] },
    { id: 3, name: 'zyphonz-helper', description: 'Legacy helper (old name)', rating: 7.8, price: 'Free', link: '#', tags: ['util'] }
  ];
  // normalize: will convert zyphonz -> lunaz in apps
  applications = normalizeNamesInApps(applications);
  categories = Array.from(new Set(['all','free','tv','python','ai','security','linux','web','util']));
  saveLocal(); renderApplications(); renderCategories(); updateAppCount();
  showStatus('Sample data loaded');
}
document.getElementById('btn-load-sample').addEventListener('click', loadSampleData);

function clearAllData(){
  if(!confirm('Clear all app data locally?')) return;
  applications = []; categories = ['all','util','tv','python','ai','security','gaming'];
  saveLocal(); renderApplications(); renderCategories(); updateAppCount(); showStatus('Cleared local data');
}
document.getElementById('btn-clear').addEventListener('click', clearAllData);

/* Dev panel open/close */
document.getElementById('btn-dev').addEventListener('click', ()=> {
  document.getElementById('dev-panel').style.display = 'flex';
});
function closeDevPanel(){ document.getElementById('dev-panel').style.display = 'none'; }

/* Add-app form submit */
document.getElementById('add-app-form').addEventListener('submit', addApplicationFromForm);

/* Login flow */
document.getElementById('login-form').addEventListener('submit', function(ev){
  ev.preventDefault();
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value;
  const msg = document.getElementById('login-message');
  if(user === DEV_CREDENTIALS.username && pass === DEV_CREDENTIALS.password){
    isDevLoggedIn = true;
    msg.textContent = 'Login successful';
    setTimeout(()=> { document.getElementById('login-panel').style.display = 'none'; document.getElementById('dev-panel').style.display = 'flex'; msg.textContent = ''; }, 600);
  } else {
    msg.textContent = 'Invalid credentials';
  }
});
function closeLoginPanel(){ document.getElementById('login-panel').style.display = 'none'; }

/* open login */
function showLogin(){ document.getElementById('login-panel').style.display = 'flex'; }

/* settings modal open/close & draggable behavior */
const settingsBackdrop = document.getElementById('settings-backdrop');
const settingsModal = document.getElementById('settings-modal');
const settingsHeader = document.getElementById('settings-header');
let drag = { active:false, startX:0, startY:0, origX:0, origY:0 };

function openSettings(){
  // load UI controls with current settings
  const accent = localStorage.getItem('ember_accent') || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  document.getElementById('accent-input').value = rgbToHex(accent);
  document.getElementById('particles-toggle').checked = (localStorage.getItem('ember_particles') !== 'false');
  document.getElementById('particles-density').value = localStorage.getItem('ember_particles_density') || 80;
  document.getElementById('particles-speed').value = localStorage.getItem('ember_particles_speed') || 0.6;
  document.getElementById('density-val').textContent = document.getElementById('particles-density').value;
  document.getElementById('speed-val').textContent = document.getElementById('particles-speed').value;
  settingsBackdrop.style.display = 'flex';
}

function closeSettings(){ settingsBackdrop.style.display = 'none'; saveSettings(); }

document.getElementById('btn-settings').addEventListener('click', openSettings);
document.getElementById('close-settings').addEventListener('click', closeSettings);
document.getElementById('restore-defaults').addEventListener('click', function(){
  applyAccent('#ff7a2e');
  document.getElementById('preset-orange').click();
  document.getElementById('particles-toggle').checked = true;
  document.getElementById('particles-density').value = 80;
  document.getElementById('particles-speed').value = 0.6;
  document.getElementById('density-val').textContent = 80;
  document.getElementById('speed-val').textContent = 0.6;
  saveSettings();
});

/* color presets */
document.getElementById('preset-orange').addEventListener('click', ()=> { applyAccent('#ff7a2e'); document.getElementById('accent-input').value = '#ff7a2e'; });
document.getElementById('preset-pink').addEventListener('click', ()=> { applyAccent('#f48fb1'); document.getElementById('accent-input').value = '#f48fb1'; });

document.getElementById('accent-input').addEventListener('input', (e)=> applyAccent(e.target.value));

document.getElementById('particles-toggle').addEventListener('change', (e)=> {
  const on = e.target.checked;
  localStorage.setItem('ember_particles', on ? 'true' : 'false');
  particlesEnabled = on;
});
document.getElementById('particles-density').addEventListener('input', (e)=> {
  const v = Number(e.target.value); document.getElementById('density-val').textContent = v; localStorage.setItem('ember_particles_density', v);
  particleTargetCount = v;
});
document.getElementById('particles-speed').addEventListener('input', (e)=> {
  const v = Number(e.target.value); document.getElementById('speed-val').textContent = v; localStorage.setItem('ember_particles_speed', v);
  particleSpeedMultiplier = v;
});

/* draggable modal mechanics */
settingsHeader.addEventListener('mousedown', (e)=>{
  drag.active = true;
  drag.startX = e.clientX; drag.startY = e.clientY;
  const rect = settingsModal.getBoundingClientRect();
  drag.origX = rect.left; drag.origY = rect.top;
  settingsModal.style.transition = 'none';
  settingsHeader.style.cursor = 'grabbing';
  e.preventDefault();
});
document.addEventListener('mousemove', (e)=>{
  if(!drag.active) return;
  const dx = e.clientX - drag.startX; const dy = e.clientY - drag.startY;
  settingsModal.style.position = 'fixed';
  settingsModal.style.left = (drag.origX + dx) + 'px';
  settingsModal.style.top = (drag.origY + dy) + 'px';
});
document.addEventListener('mouseup', ()=>{
  if(drag.active){ drag.active = false; settingsModal.style.transition = ''; settingsHeader.style.cursor = 'grab'; }
});

/* helper to open simple modal */
function openModal(html){
  const mb = document.getElementById('settings-backdrop');
  // reuse settings-backdrop area as generic modal if settings closed
  const modal = document.getElementById('settings-modal');
  modal.innerHTML = html;
  mb.style.display = 'flex';
  // center it
  modal.style.left = ''; modal.style.top = ''; modal.style.position = '';
}
function closeModal(){ document.getElementById('settings-backdrop').style.display = 'none'; }

/* settings application */
function applyAccent(hex){
  if(!hex) return;
  document.documentElement.style.setProperty('--accent', hex);
  localStorage.setItem('ember_accent', hex);
}
function saveSettings(){
  const accent = document.getElementById('accent-input').value;
  const particlesOn = document.getElementById('particles-toggle').checked;
  const density = document.getElementById('particles-density').value;
  const speed = document.getElementById('particles-speed').value;
  applyAccent(accent);
  localStorage.setItem('ember_particles', particlesOn ? 'true' : 'false');
  localStorage.setItem('ember_particles_density', density);
  localStorage.setItem('ember_particles_speed', speed);
}

/* util: rgb to hex (accepts '#xxxx' or ' rgb(...)' or hex) */
function rgbToHex(input){
  if(!input) return '#ff7a2e';
  input = String(input).trim();
  if(input[0] === '#') return input;
  const m = input.match(/(\d+),\s*(\d+),\s*(\d+)/);
  if(m) {
    const r = parseInt(m[1]), g = parseInt(m[2]), b = parseInt(m[3]);
    return "#" + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('');
  }
  return '#ff7a2e';
}

/* ======= Particles Canvas ======= */
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d', { alpha:true });
let particles = [];
let particleTargetCount = Number(localStorage.getItem('ember_particles_density') || 80);
let particlesEnabled = (localStorage.getItem('ember_particles') !== 'false');
let particleSpeedMultiplier = Number(localStorage.getItem('ember_particles_speed') || 0.6);
let w = 0, h = 0;

function resizeCanvas(){
  w = canvas.width = Math.round(window.innerWidth * devicePixelRatio);
  h = canvas.height = Math.round(window.innerHeight * devicePixelRatio);
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Particle {
  constructor(){
    this.reset(true);
  }
  reset(initial=false){
    this.x = Math.random() * w;
    this.y = Math.random() * h;
    this.vx = (Math.random() - 0.5) * 0.3 * particleSpeedMultiplier * devicePixelRatio;
    this.vy = (Math.random() - 0.5) * 0.3 * particleSpeedMultiplier * devicePixelRatio;
    this.r = (1 + Math.random()*2) * devicePixelRatio;
    this.alpha = 0.2 + Math.random()*0.6;
    if(initial) {
      this.x = Math.random() * w; this.y = Math.random() * h;
    }
  }
  step(){
    this.x += this.vx;
    this.y += this.vy;
    // slight wrap
    if(this.x < -20) this.x = w + 20;
    if(this.x > w + 20) this.x = -20;
    if(this.y < -20) this.y = h + 20;
    if(this.y > h + 20) this.y = -20;
  }
  draw(){
    ctx.beginPath();
    const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.r*6);
    gradient.addColorStop(0, hexToRgba(getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(), this.alpha));
    gradient.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = gradient;
    ctx.arc(this.x, this.y, this.r*6, 0, Math.PI*2);
    ctx.fill();
  }
}

function hexToRgba(hex, alpha){
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
  const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function ensureParticleCount(){
  const desired = Math.max(0, Math.min(800, Math.round(particleTargetCount)));
  while(particles.length < desired) particles.push(new Particle());
  while(particles.length > desired) particles.pop();
}

function animateParticles(){
  ctx.clearRect(0,0,w,h);
  if(particlesEnabled){
    ensureParticleCount();
    for(let p of particles){ p.step(); p.draw(); }
    // optionally: draw connecting lines (subtle)
    // keep it minimal to stay professional
    for(let i=0;i<particles.length;i++){
      const a = particles[i];
      for(let j=i+1;j<i+4 && j<particles.length;j++){
        const b = particles[j];
        const dx = a.x - b.x, dy = a.y - b.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < 160 * devicePixelRatio){
          ctx.beginPath();
          ctx.strokeStyle = hexToRgba(getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(), 0.03);
          ctx.lineWidth = 1 * devicePixelRatio;
          ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        }
      }
    }
  } else {
    // clear shallow if disabled
  }
  requestAnimationFrame(animateParticles);
}
ensureParticleCount();
requestAnimationFrame(animateParticles);

/* small helper to open modal used earlier */
function openModal(html){
  const mb = document.getElementById('settings-backdrop');
  settingsModal.innerHTML = html;
  mb.style.display = 'flex';
  settingsModal.style.left = ''; settingsModal.style.top = ''; settingsModal.style.position = '';
}

/* small close */
document.getElementById('settings-backdrop').addEventListener('click', (e)=>{
  if(e.target === document.getElementById('settings-backdrop')) {
    // if generic modal displayed, close
    document.getElementById('settings-backdrop').style.display = 'none';
    // reset modal position so next open is centered
    settingsModal.style.position = ''; settingsModal.style.left = ''; settingsModal.style.top = '';
  }
});

/* initialize: attempt remote fetch; if fail, load local */
(async function init(){
  // apply saved accent if any
  const savedAccent = localStorage.getItem('ember_accent');
  if(savedAccent) applyAccent(savedAccent);
  particleTargetCount = Number(localStorage.getItem('ember_particles_density') || particleTargetCount);
  particlesEnabled = (localStorage.getItem('ember_particles') !== 'false');
  particleSpeedMultiplier = Number(localStorage.getItem('ember_particles_speed') || particleSpeedMultiplier);

  // attach small noise to devicePixelRatio
  window.devicePixelRatio = window.devicePixelRatio || 1;

  if(BIN_ID && API_KEY){
    try{
      await fetchData();
    }catch(err){
      console.warn('remote init failed', err);
      loadFromLocal();
    }
  } else {
    loadFromLocal();
  }

  // hide initial loading overlay if present
  const loader = document.getElementById('loading-screen');
  if(loader) loader.style.display = 'none';

  // wire some remaining UI
  document.getElementById('btn-settings').addEventListener('click', openSettings);
  document.getElementById('btn-sample').addEventListener('click', loadSampleData);
  document.getElementById('btn-add').addEventListener('click', ()=> { document.getElementById('dev-panel').style.display = 'flex'; });
  document.getElementById('btn-export2').addEventListener('click', exportData);

  // update counts
  updateAppCount();
  ensureParticleCount();
  // reflect initial slider labels
  const den = document.getElementById('particles-density'); if(den) document.getElementById('density-val').textContent = den.value;
  const spd = document.getElementById('particles-speed'); if(spd) document.getElementById('speed-val').textContent = spd.value;
})();
